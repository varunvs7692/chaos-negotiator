name: Deploy to Azure

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ${{ secrets.AZURE_REGISTRY_URL }}
  IMAGE_NAME: chaos-negotiator
  AZURE_RESOURCE_GROUP: chaos-negotiator-rg
  AZURE_APP_NAME: chaos-negotiator

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    permissions:
      id-token: write
      contents: read
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
    
    - name: Run tests
      run: pytest tests/ -v

    - name: Validate Azure auth secrets
      run: |
        test -n "${{ secrets.AZURE_CLIENT_ID }}" || (echo "Missing AZURE_CLIENT_ID" && exit 1)
        test -n "${{ secrets.AZURE_TENANT_ID }}" || (echo "Missing AZURE_TENANT_ID" && exit 1)
        test -n "${{ secrets.AZURE_SUBSCRIPTION_ID }}" || (echo "Missing AZURE_SUBSCRIPTION_ID" && exit 1)
        test -n "${{ secrets.AZURE_CLIENT_SECRET }}" || (echo "Missing AZURE_CLIENT_SECRET" && exit 1)
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: |
          {
            "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
            "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
            "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
            "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
          }
    
    - name: Login to Azure Container Registry
      uses: azure/docker-login@v1
      with:
        login-server: ${{ env.REGISTRY }}
        username: ${{ secrets.AZURE_REGISTRY_USERNAME }}
        password: ${{ secrets.AZURE_REGISTRY_PASSWORD }}
    
    - name: Build Docker image
      if: success()
      run: |
        docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} .
        docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest .
    
    - name: Push Docker image
      if: success()
      run: |
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
    
    - name: Deploy Bicep infrastructure
      if: success()
      uses: azure/arm-deploy@v1
      with:
        subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        resourceGroupName: ${{ env.AZURE_RESOURCE_GROUP }}
        template: ./infra/main.bicep
        scope: resourcegroup
        parameters: |
          location=eastus
          environment=prod
          appName=${{ env.AZURE_APP_NAME }}
    
    - name: Update Container App
      if: success()
      run: |
        az containerapp update \
          --name ${{ env.AZURE_APP_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --image ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
    
    - name: Set secrets in Key Vault
      if: success()
      run: |
        az keyvault secret set \
          --vault-name "chaos-negotiator-kv" \
          --name "azure-openai-key" \
          --value "${{ secrets.AZURE_OPENAI_KEY }}"
        az keyvault secret set \
          --vault-name "chaos-negotiator-kv" \
          --name "azure-openai-endpoint" \
          --value "${{ secrets.AZURE_OPENAI_ENDPOINT }}"
