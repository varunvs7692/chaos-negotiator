name: Deploy to Azure

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ${{ secrets.AZURE_REGISTRY_URL }}
  IMAGE_NAME: chaos-negotiator
  AZURE_RESOURCE_GROUP: chaos-negotiator-rg
  AZURE_APP_NAME: chaos-negotiator
  AZURE_REGISTRY_NAME: chaosnegroreg13921
  AZURE_OPENAI_API_VERSION: 2024-02-15-preview

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    permissions:
      id-token: write
      contents: read
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
    
    - name: Run tests
      run: pytest tests/ -v

    - name: Validate Azure auth secrets
      run: |
        test -n "${{ secrets.AZURE_CLIENT_ID }}" || (echo "Missing AZURE_CLIENT_ID" && exit 1)
        test -n "${{ secrets.AZURE_TENANT_ID }}" || (echo "Missing AZURE_TENANT_ID" && exit 1)
        test -n "${{ secrets.AZURE_SUBSCRIPTION_ID }}" || (echo "Missing AZURE_SUBSCRIPTION_ID" && exit 1)
        test -n "${{ secrets.AZURE_CLIENT_SECRET }}" || (echo "Missing AZURE_CLIENT_SECRET" && exit 1)
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: |
          {
            "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
            "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
            "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
            "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
          }

    - name: Deploy Bicep infrastructure
      if: success()
      uses: azure/arm-deploy@v1
      with:
        subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        resourceGroupName: ${{ env.AZURE_RESOURCE_GROUP }}
        template: ./infra/main.bicep
        scope: resourcegroup
        parameters: location=eastus environment=prod appName=${{ env.AZURE_APP_NAME }} containerRegistryName=${{ env.AZURE_REGISTRY_NAME }} azureOpenAiKey="${{ secrets.AZURE_OPENAI_KEY }}" azureOpenAiEndpoint="${{ secrets.AZURE_OPENAI_ENDPOINT }}" openAiApiVersion=${{ env.AZURE_OPENAI_API_VERSION }}
    
    - name: Login to Azure Container Registry
      uses: azure/docker-login@v1
      with:
        login-server: ${{ env.REGISTRY }}
        username: ${{ secrets.AZURE_REGISTRY_USERNAME }}
        password: ${{ secrets.AZURE_REGISTRY_PASSWORD }}

    - name: Validate registry URL
      if: success()
      run: |
        if [ -z "${{ env.REGISTRY }}" ]; then
          echo "Missing AZURE_REGISTRY_URL" && exit 1
        fi
        if echo "${{ env.REGISTRY }}" | grep -q "[[:space:]]"; then
          echo "AZURE_REGISTRY_URL contains whitespace" && exit 1
        fi
        if ! echo "${{ env.REGISTRY }}" | grep -qi "\.azurecr\.io$"; then
          echo "AZURE_REGISTRY_URL must end with .azurecr.io" && exit 1
        fi
    
    - name: Build Docker image
      if: success()
      run: |
        docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} .
        docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest .
    
    - name: Push Docker image
      if: success()
      run: |
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

    - name: Wait for Container App provisioning
      if: success()
      run: |
        for i in {1..30}; do
          state=$(az containerapp show --name ${{ env.AZURE_APP_NAME }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --query properties.provisioningState -o tsv || echo "Unknown")
          if [ "$state" = "Succeeded" ]; then
            echo "Container App ready."
            exit 0
          fi
          echo "Provisioning state: $state (attempt $i/30). Waiting..."
          sleep 10
        done
        echo "Container App still provisioning after wait."
        exit 1
    
    - name: Update Container App
      if: success()
      run: |
        az containerapp update \
          --name ${{ env.AZURE_APP_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --image ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

    - name: Post-deploy smoke test
      if: success()
      run: |
        APP_FQDN=$(az containerapp show --name ${{ env.AZURE_APP_NAME }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --query properties.configuration.ingress.fqdn -o tsv)
        if [ -z "$APP_FQDN" ]; then
          echo "Failed to resolve Container App FQDN"
          exit 1
        fi

        APP_URL="https://$APP_FQDN"
        echo "Running smoke tests against $APP_URL"

        curl -fsS "$APP_URL/api" >/dev/null

        ANALYZE_BODY='{"deployment_id":"smoke-deploy","service_name":"smoke-service","environment":"staging","version":"v0.0.1","changes":[{"file_path":"src/smoke.py","change_type":"modify","lines_changed":1,"risk_tags":["test"],"description":"CI smoke test"}]}'

        curl -fsS -X POST "$APP_URL/analyze" \
          -H "Content-Type: application/json" \
          --data "$ANALYZE_BODY" >/dev/null
    
    - name: Set secrets in Key Vault
      if: success()
      run: |
        KV_NAME=$(echo "${{ env.AZURE_APP_NAME }}-kv" | tr -d '-')
        for i in {1..12}; do
          if az keyvault secret set --vault-name "$KV_NAME" --name "azure-openai-key" --value "${{ secrets.AZURE_OPENAI_KEY }}" >/dev/null 2>&1 \
            && az keyvault secret set --vault-name "$KV_NAME" --name "azure-openai-endpoint" --value "${{ secrets.AZURE_OPENAI_ENDPOINT }}" >/dev/null 2>&1; then
            echo "Key Vault secrets set successfully."
            exit 0
          fi
          echo "Key Vault RBAC not ready yet (attempt $i/12). Waiting 15s..."
          sleep 15
        done
        echo "Failed to set Key Vault secrets after retries."
        exit 1
